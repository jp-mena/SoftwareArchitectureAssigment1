{% extends "base" %}

{% block title %}Panel de Administración - Book Reviews{% endblock %}

{% block content %}
<h2>🎯 Panel de Administración</h2>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0;">
    
    <!-- Tarjeta de Autores -->
    <div class="author-card">
        <h3>👥 Gestión de Autores</h3>
        <p>Administra los autores de la biblioteca</p>
        <div class="author-actions">
            <a href="/admin/authors" style="text-decoration: none;">
                <button class="btn-success">📋 Ver Todos</button>
            </a>
            <a href="/admin/authors/new" style="text-decoration: none;">
                <button>➕ Crear Nuevo</button>
            </a>
        </div>
    </div>

    <!-- Tarjeta de Libros -->
    <div class="author-card">
        <h3>📚 Gestión de Libros</h3>
        <p>Administra el catálogo de libros</p>
        <div class="author-actions">
            <a href="/admin/books" style="text-decoration: none;">
                <button class="btn-success">📋 Ver Todos</button>
            </a>
            <a href="/admin/books/new" style="text-decoration: none;">
                <button>➕ Crear Nuevo</button>
            </a>
        </div>
    </div>

    <!-- Tarjeta de Reseñas -->
    <div class="author-card">
        <h3>⭐ Gestión de Reseñas</h3>
        <p>Administra las reseñas de libros</p>
        <div class="author-actions">
            <a href="/admin/reviews" style="text-decoration: none;">
                <button class="btn-success">📋 Ver Todas</button>
            </a>
            <a href="/admin/reviews/new" style="text-decoration: none;">
                <button>➕ Crear Nueva</button>
            </a>
        </div>
    </div>

    <!-- Tarjeta de Ventas -->
    <div class="author-card">
        <h3>💰 Gestión de Ventas</h3>
        <p>Administra las estadísticas de ventas</p>
        <div class="author-actions">
            <a href="/admin/sales" style="text-decoration: none;">
                <button class="btn-success">📋 Ver Todas</button>
            </a>
            <a href="/admin/sales/new" style="text-decoration: none;">
                <button>➕ Crear Nueva</button>
            </a>
        </div>
    </div>

    <!-- Tarjeta de API -->
    <div class="author-card">
        <h3>🔗 API Testing</h3>
        <p>Prueba directamente los endpoints de la API</p>
        <div class="author-actions">
            <button onclick="testAPI()">🔍 Probar Conexión</button>
            <button onclick="showAPIEndpoints()" class="btn-success">📖 Ver Endpoints</button>
        </div>
    </div>

    <!-- Tarjeta de Base de Datos -->
    <div class="author-card">
        <h3>🗄️ Estado de la Base de Datos</h3>
        <p>Verificar conexión y estado</p>
        <div class="author-actions">
            <button onclick="checkDB()">🔍 Verificar DB</button>
            <div id="db-status" style="margin-top: 10px; font-family: monospace;"></div>
        </div>
    </div>

</div>

<!-- Área de respuestas -->
<div id="api-response" class="json-response" style="display: none;"></div>

<!-- Modal para mostrar endpoints -->
<div id="endpoints-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 800px; max-height: 80%; overflow-y: auto;">
        <h3>📖 API Endpoints Disponibles</h3>
        <div id="endpoints-content">
            <h4>👥 Authors:</h4>
            <ul>
                <li>GET /api/authors - Obtener todos los autores</li>
                <li>GET /api/authors/{id} - Obtener autor por ID</li>
                <li>POST /api/authors - Crear nuevo autor</li>
                <li>PUT /api/authors/{id} - Actualizar autor</li>
                <li>DELETE /api/authors/{id} - Eliminar autor</li>
            </ul>
            
            <h4>📚 Books:</h4>
            <ul>
                <li>GET /api/books - Obtener todos los libros</li>
                <li>GET /api/books/{id} - Obtener libro por ID</li>
                <li>POST /api/books - Crear nuevo libro</li>
                <li>PUT /api/books/{id} - Actualizar libro</li>
                <li>DELETE /api/books/{id} - Eliminar libro</li>
            </ul>
            
            <h4>⭐ Reviews:</h4>
            <ul>
                <li>GET /api/reviews - Obtener todas las reseñas</li>
                <li>GET /api/reviews/{id} - Obtener reseña por ID</li>
                <li>GET /api/reviews/book/{book_id} - Reseñas de un libro</li>
                <li>POST /api/reviews - Crear nueva reseña</li>
                <li>PUT /api/reviews/{id} - Actualizar reseña</li>
                <li>DELETE /api/reviews/{id} - Eliminar reseña</li>
                <li>POST /api/reviews/{id}/upvote - Dar upvote a reseña</li>
            </ul>
            
            <h4>💰 Sales:</h4>
            <ul>
                <li>GET /api/sales - Obtener todas las ventas</li>
                <li>GET /api/sales/{id} - Obtener venta por ID</li>
                <li>GET /api/sales/book/{book_id} - Ventas de un libro</li>
                <li>GET /api/sales/year/{year} - Ventas de un año</li>
                <li>POST /api/sales - Crear nueva venta</li>
                <li>PUT /api/sales/{id} - Actualizar venta</li>
                <li>DELETE /api/sales/{id} - Eliminar venta</li>
            </ul>
        </div>
        <button onclick="closeEndpointsModal()" class="btn-danger">❌ Cerrar</button>
    </div>
</div>

<h3>📊 Estadísticas Rápidas</h3>
<div id="stats" class="author-card">
    <p>Cargando estadísticas...</p>
</div>

<script>
    // Cargar estadísticas al iniciar
    window.onload = function() {
        loadStats();
    }

    // Función para mostrar endpoints
    function showAPIEndpoints() {
        document.getElementById('endpoints-modal').style.display = 'block';
    }

    function closeEndpointsModal() {
        document.getElementById('endpoints-modal').style.display = 'none';
    }

    // Función para probar la API
    async function testAPI() {
        const response = await apiRequest('/api/authors');
        showResponse('api-response', response);
        
        if (response.success) {
            alert('✅ API funcionando correctamente!');
        } else {
            alert('❌ Error en la API: ' + response.error);
        }
    }

    // Función para verificar la base de datos
    async function checkDB() {
        const statusDiv = document.getElementById('db-status');
        statusDiv.innerHTML = 'Verificando...';
        
        try {
            const response = await fetch('/health/db');
            const text = await response.text();
            statusDiv.innerHTML = `<span style="color: green;">✅ ${text}</span>`;
        } catch (error) {
            statusDiv.innerHTML = `<span style="color: red;">❌ Error: ${error.message}</span>`;
        }
    }

    // Función para cargar estadísticas
    async function loadStats() {
        const statsDiv = document.getElementById('stats');
        
        try {
            // Obtener estadísticas de cada entidad
            const [authorsResp, booksResp, reviewsResp, salesResp] = await Promise.all([
                apiRequest('/api/authors'),
                apiRequest('/api/books'),
                apiRequest('/api/reviews'),
                apiRequest('/api/sales')
            ]);

            const authorsCount = authorsResp.success ? authorsResp.data.data.length : 0;
            const booksCount = booksResp.success ? booksResp.data.data.length : 0;
            const reviewsCount = reviewsResp.success ? reviewsResp.data.data.length : 0;
            const salesCount = salesResp.success ? salesResp.data.data.length : 0;

            statsDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: #e8f4f8; border-radius: 8px;">
                        <h4>👥 Autores</h4>
                        <span style="font-size: 2em; color: #007bff;">${authorsCount}</span>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f0f8e8; border-radius: 8px;">
                        <h4>📚 Libros</h4>
                        <span style="font-size: 2em; color: #28a745;">${booksCount}</span>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #fff8e1; border-radius: 8px;">
                        <h4>⭐ Reseñas</h4>
                        <span style="font-size: 2em; color: #ffc107;">${reviewsCount}</span>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8e8f8; border-radius: 8px;">
                        <h4>💰 Ventas</h4>
                        <span style="font-size: 2em; color: #dc3545;">${salesCount}</span>
                    </div>
                </div>
            `;
        } catch (error) {
            statsDiv.innerHTML = `<p style="color: red;">Error cargando estadísticas: ${error.message}</p>`;
        }
    }
</script>
{% endblock %}
